<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veterans</title>

  <style>
    :root{
      --border:#e5e7eb;
      --muted:#475569;
      --head:#f8fafc;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
      --focus:#94a3b8;
    }
    body{
      margin:0;
      background:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#0f172a;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:12px; }

    .topbar{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap; margin-bottom:10px;
    }
    .title{ font-size:18px; font-weight:800; margin:0; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.3; }
    .status{
      font-size:12px; color:var(--muted);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .dot{ width:8px;height:8px;border-radius:999px;background:#94a3b8;display:inline-block; }
    .dot.ok{ background:#22c55e; } .dot.bad{ background:#ef4444; }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }

    table.responsive{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ border:1px solid var(--border); padding:10px 12px; text-align:left; vertical-align:middle; }
    thead th{
      background:var(--head);
      font-weight:800;
      position:sticky; top:0; z-index:1;
      user-select:none; cursor:pointer; white-space:nowrap;
    }
    thead th .sort-ind{ font-size:12px; color:var(--muted); margin-left:6px; }

    .badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-weight:700; font-size:12px; border:1px solid var(--border); white-space:nowrap;
    }
    .badge-none{ background:#f3f4f6; }
    .badge-low{ background:#fee2e2; border-color:#fecaca; }
    .badge-high{ background:#dcfce7; border-color:#bbf7d0; }

    td[contenteditable="true"]{ background:#fff; outline:none; }
    td[contenteditable="true"]:focus{ box-shadow: inset 0 0 0 2px var(--focus); border-color: transparent; }
    td[contenteditable="true"][data-saving="true"]{ background:#f8fafc; }

    @media (max-width: 720px){
      table.responsive thead{ display:none; }
      table.responsive, table.responsive tbody, table.responsive tr, table.responsive td{ display:block; width:100%; }
      table.responsive tr{
        border:1px solid var(--border);
        border-radius:12px;
        overflow:hidden;
        margin-bottom:12px;
        background:#fff;
        box-shadow:var(--shadow);
      }
      table.responsive td{
        border:none;
        border-bottom:1px solid #f1f5f9;
        padding:10px 12px;
        display:grid;
        grid-template-columns:120px 1fr;
        gap:10px;
      }
      table.responsive td:last-child{ border-bottom:none; }
      table.responsive td::before{ content:attr(data-label); font-weight:800; color:var(--muted); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">Veterans</h1>
        <div class="hint">
          Desktop : clique sur un en-t√™te pour trier (re-clique = inverse).<br>
          Shooter 1 / Shooter 2 / Following : clique pour √©crire puis clique ailleurs (auto-save).<br>
          ‚ö†Ô∏è Effacer une cellule est bloqu√© (anti-troll) : √ßa restaure l‚Äôancienne valeur.
        </div>
      </div>

      <div class="status">
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Chargement‚Ä¶</span>
      </div>
    </div>

    <table class="responsive" id="veteransTable">
      <thead>
        <tr>
          <th data-type="position">Position<span class="sort-ind"></span></th>
          <th data-type="text">Username<span class="sort-ind"></span></th>
          <th data-type="plating">Plating<span class="sort-ind"></span></th>
          <th data-type="text">Rank<span class="sort-ind"></span></th>
          <th data-type="text">Family<span class="sort-ind"></span></th>
          <th data-type="text">Shooter 1<span class="sort-ind"></span></th>
          <th data-type="text">Shooter 2<span class="sort-ind"></span></th>
          <th data-type="text">Following<span class="sort-ind"></span></th>
        </tr>
      </thead>

      <tbody>
        <!-- (Je garde ton subset, tu peux remettre toutes tes lignes quand tu veux) -->
        <tr data-id="59">
          <td data-label="Position">#59</td>
          <td data-label="Username">Quant</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="92">
          <td data-label="Position">92</td>
          <td data-label="Username">Gernas</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="96">
          <td data-label="Position">96</td>
          <td data-label="Username">Kaleli</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="101">
          <td data-label="Position">101</td>
          <td data-label="Username">Mkk</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="106">
          <td data-label="Position">106</td>
          <td data-label="Username">Namaste</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="118">
          <td data-label="Position">118</td>
          <td data-label="Username">Avenger</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="662">
          <td data-label="Position">662</td>
          <td data-label="Username">Cemil</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    /***********************
     * 1) TRI (clic headers)
     ***********************/
    (function(){
      const table = document.getElementById("veteransTable");
      const tbody = table.querySelector("tbody");
      const headers = Array.from(table.querySelectorAll("thead th"));

      const platingScore = (v) => {
        const s = (v || "").trim().toLowerCase();
        if (!s || s === "none") return 0;
        if (s === "very low") return 1;
        if (s === "low") return 2;
        if (s === "medium") return 3;
        if (s === "high") return 4;
        if (s === "very high") return 5;
        return 999;
      };
      const parsePosition = (v) => {
        const m = String(v || "").match(/(\d+)/);
        return m ? parseInt(m[1], 10) : Number.POSITIVE_INFINITY;
      };
      const getCellText = (row, idx) => {
        const cell = row.children[idx];
        if (!cell) return "";
        const badge = cell.querySelector(".badge");
        if (badge) return badge.textContent.trim();
        return cell.textContent.trim();
      };

      let currentSort = { idx: 0, asc: true };

      const updateIndicators = () => {
        headers.forEach((h, i) => {
          const ind = h.querySelector(".sort-ind");
          if (!ind) return;
          ind.textContent = (i === currentSort.idx) ? (currentSort.asc ? "‚ñ≤" : "‚ñº") : "";
        });
      };

      const sortBy = (idx, type) => {
        const rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort((a,b) => {
          const av = getCellText(a, idx);
          const bv = getCellText(b, idx);
          let cmp = 0;
          if (type === "position") cmp = parsePosition(av) - parsePosition(bv);
          else if (type === "plating") cmp = platingScore(av) - platingScore(bv);
          else cmp = av.localeCompare(bv, undefined, { numeric:true, sensitivity:"base" });
          return currentSort.asc ? cmp : -cmp;
        });
        rows.forEach(r => tbody.appendChild(r));
        updateIndicators();
      };

      headers.forEach((h, idx) => {
        const type = h.getAttribute("data-type") || "text";
        h.addEventListener("click", () => {
          if (currentSort.idx === idx) currentSort.asc = !currentSort.asc;
          else { currentSort.idx = idx; currentSort.asc = true; }
          sortBy(idx, type);
        });
      });

      updateIndicators();
    })();

    /********************************************
     * 2) EDIT PARTAG√â (Google Apps Script JSONP)
     ********************************************/
    (function(){
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1X_eqpP1ERruQ56SZDqSY1JTNVMZ9Pbnga289m2X8jjta3ZzPJ8jbrxK1nqMg9GPF4w/exec";
      const API_KEY = "ArkhamCoreSecret123";

      const table = document.getElementById("veteransTable");
      const tbody = table.querySelector("tbody");
      const refreshBtn = document.getElementById("refreshBtn");

      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");

      function setStatus(kind, text){
        statusDot.classList.remove("ok","bad");
        if (kind === "ok") statusDot.classList.add("ok");
        if (kind === "bad") statusDot.classList.add("bad");
        statusText.textContent = text;
      }

      // Stocke la derni√®re valeur connue (pour restaurer si quelqu‚Äôun efface)
      function snapshotPrevValues(){
        tbody.querySelectorAll("tr[data-id]").forEach(tr => {
          tr.querySelectorAll("td[data-field]").forEach(td => {
            td.dataset.prev = td.textContent.trim();
          });
        });
      }

      function loadSharedData(){
        return new Promise((resolve) => {
          setStatus("", "Chargement‚Ä¶");

          const cbName = "cb_" + Math.random().toString(36).slice(2);
          const script = document.createElement("script");

          window[cbName] = (json) => {
            try {
              if (!json || !json.ok) {
                console.warn("Load failed:", json);
                setStatus("bad", "Erreur de chargement");
                return resolve(false);
              }

              tbody.querySelectorAll("tr[data-id]").forEach(tr => {
                const id = tr.getAttribute("data-id");
                const row = json.rows && json.rows[id];
                if (!row) return;

                tr.querySelectorAll("td[data-field]").forEach(td => {
                  const field = td.getAttribute("data-field");
                  td.textContent = (row[field] ?? "").toString();
                });
              });

              snapshotPrevValues();
              setStatus("ok", "Donn√©es partag√©es charg√©es");
              resolve(true);
            } finally {
              delete window[cbName];
              script.remove();
            }
          };

          script.src =
            `${SCRIPT_URL}?action=list&key=${encodeURIComponent(API_KEY)}&callback=${encodeURIComponent(cbName)}&t=${Date.now()}`;

          script.onerror = () => {
            delete window[cbName];
            script.remove();
            setStatus("bad", "Erreur r√©seau (load)");
            resolve(false);
          };

          document.head.appendChild(script);
        });
      }

      function saveCell(tr, field, value){
        const id = tr.getAttribute("data-id");
        if (!id) return;

        const url =
          `${SCRIPT_URL}?action=save&key=${encodeURIComponent(API_KEY)}&id=${encodeURIComponent(id)}&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}&t=${Date.now()}`;

        // beacon GET (pas de lecture -> pas de CORS)
        const img = new Image();
        img.src = url;

        setStatus("ok", "Sauvegard√©");
      }

      // Debounce par cellule
      const pending = new Map();
      const cellKey = (tr, field) => `${tr.getAttribute("data-id")}:${field}`;

      // Focus: m√©morise l‚Äô√©tat avant √©dition
      table.addEventListener("focusin", (e) => {
        const td = e.target.closest("td[data-field][contenteditable='true']");
        if (!td) return;
        td.dataset.prev = td.textContent.trim();
      });

      table.addEventListener("blur", (e) => {
        const td = e.target.closest("td[data-field][contenteditable='true']");
        if (!td) return;

        const tr = td.closest("tr[data-id]");
        if (!tr) return;

        const field = td.getAttribute("data-field");
        let value = (td.textContent || "").trim().slice(0, 40);

        // Anti-effacement: si vide => restore la valeur pr√©c√©dente
        if (value === "") {
          td.textContent = td.dataset.prev || "";
          setStatus("bad", "Effacement bloqu√© (restaur√©)");
          return;
        }

        td.textContent = value;
        td.dataset.prev = value;

        const k = cellKey(tr, field);
        if (pending.get(k)) clearTimeout(pending.get(k));

        td.setAttribute("data-saving", "true");
        pending.set(k, setTimeout(() => {
          saveCell(tr, field, value);
          td.removeAttribute("data-saving");
        }, 250));
      }, true);

      table.addEventListener("keydown", (e) => {
        const td = e.target.closest("td[data-field][contenteditable='true']");
        if (!td) return;
        if (e.key === "Enter") { e.preventDefault(); td.blur(); }
      });

      refreshBtn.addEventListener("click", () => loadSharedData());

      loadSharedData();
    })();
  </script>
</body>
</html>
