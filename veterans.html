<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veterans</title>

  <style>
    :root{
      --border:#e5e7eb;
      --muted:#475569;
      --head:#f8fafc;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
      --focus:#94a3b8;
    }
    body{
      margin:0;
      background:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#0f172a;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:12px;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .title{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.3;
    }
    .status{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:#94a3b8;display:inline-block;
    }
    .dot.ok{ background:#22c55e; }
    .dot.bad{ background:#ef4444; }

    table.responsive{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th, td{
      border:1px solid var(--border);
      padding:10px 12px;
      text-align:left;
      vertical-align:middle;
    }
    thead th{
      background:var(--head);
      font-weight:800;
      position:sticky;
      top:0;
      z-index:1;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    thead th .sort-ind{
      font-size:12px;
      color:var(--muted);
      margin-left:6px;
    }

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      border:1px solid var(--border);
      white-space:nowrap;
    }
    .badge-none{ background:#f3f4f6; }
    .badge-low{ background:#fee2e2; border-color:#fecaca; }
    .badge-high{ background:#dcfce7; border-color:#bbf7d0; }

    /* editable cells */
    td[contenteditable="true"]{
      background:#fff;
      outline: none;
    }
    td[contenteditable="true"]:focus{
      box-shadow: inset 0 0 0 2px var(--focus);
      border-color: transparent;
    }
    td[contenteditable="true"][data-saving="true"]{
      background:#f8fafc;
    }

    @media (max-width: 720px){
      table.responsive thead{ display:none; }
      table.responsive, table.responsive tbody, table.responsive tr, table.responsive td{
        display:block;
        width:100%;
      }
      table.responsive tr{
        border:1px solid var(--border);
        border-radius:12px;
        overflow:hidden;
        margin-bottom:12px;
        background:#fff;
        box-shadow:var(--shadow);
      }
      table.responsive td{
        border:none;
        border-bottom:1px solid #f1f5f9;
        padding:10px 12px;
        display:grid;
        grid-template-columns:120px 1fr;
        gap:10px;
      }
      table.responsive td:last-child{ border-bottom:none; }
      table.responsive td::before{
        content:attr(data-label);
        font-weight:800;
        color:var(--muted);
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">Veterans</h1>
        <div class="hint">
          Desktop : clique sur un en-tête (Position, Username, etc.) pour trier (re-clique = inverse).<br>
          Shooter 1 / Shooter 2 / Following : clique dans la cellule pour écrire, puis clique ailleurs (auto-save).
        </div>
      </div>
      <div class="status" id="status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Chargement…</span>
      </div>
    </div>

    <table class="responsive" id="veteransTable">
      <thead>
        <tr>
          <th data-type="position">Position<span class="sort-ind"></span></th>
          <th data-type="text">Username<span class="sort-ind"></span></th>
          <th data-type="plating">Plating<span class="sort-ind"></span></th>
          <th data-type="text">Rank<span class="sort-ind"></span></th>
          <th data-type="text">Family<span class="sort-ind"></span></th>
          <th data-type="text">Shooter 1<span class="sort-ind"></span></th>
          <th data-type="text">Shooter 2<span class="sort-ind"></span></th>
          <th data-type="text">Following<span class="sort-ind"></span></th>
        </tr>
      </thead>

      <tbody>
        <tr data-id="46">
          <td data-label="Position">#46</td>
          <td data-label="Username">Roque</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="59">
          <td data-label="Position">#59</td>
          <td data-label="Username">Quant</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="92">
          <td data-label="Position">92</td>
          <td data-label="Username">Gernas</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="96">
          <td data-label="Position">96</td>
          <td data-label="Username">Kaleli</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="101">
          <td data-label="Position">101</td>
          <td data-label="Username">Mkk</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="106">
          <td data-label="Position">106</td>
          <td data-label="Username">Namaste</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="118">
          <td data-label="Position">118</td>
          <td data-label="Username">Avenger</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>
        
        <tr data-id="145">
          <td data-label="Position">145</td>
          <td data-label="Username">Rebit</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="146">
          <td data-label="Position">146</td>
          <td data-label="Username">Javanase</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="187">
          <td data-label="Position">187</td>
          <td data-label="Username">Tm</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="234">
          <td data-label="Position">234</td>
          <td data-label="Username">Protesto</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="241">
          <td data-label="Position">241</td>
          <td data-label="Username">Tekk</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="244">
          <td data-label="Position">244</td>
          <td data-label="Username">Ataa</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="261">
          <td data-label="Position">261</td>
          <td data-label="Username">Sor</td>
          <td data-label="Plating"><span class="badge badge-low">Very Low</span></td>
          <td data-label="Rank">Bruglione</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="270">
          <td data-label="Position">270</td>
          <td data-label="Username">Combat</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="336">
          <td data-label="Position">336</td>
          <td data-label="Username">Musamba</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="407">
          <td data-label="Position">407</td>
          <td data-label="Username">Lm</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="409">
          <td data-label="Position">409</td>
          <td data-label="Username">Asy</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="443">
          <td data-label="Position">443</td>
          <td data-label="Username">Xxdangerouss</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="463">
          <td data-label="Position">463</td>
          <td data-label="Username">Smirnoff</td>
          <td data-label="Plating"><span class="badge badge-none">None</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="483">
          <td data-label="Position">483</td>
          <td data-label="Username">Oh</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="504">
          <td data-label="Position">504</td>
          <td data-label="Username">Hotplay</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>
        
        <tr data-id="558">
          <td data-label="Position">558</td>
          <td data-label="Username">Galatasaray</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>

        <tr data-id="662">
          <td data-label="Position">662</td>
          <td data-label="Username">Cemil</td>
          <td data-label="Plating"><span class="badge badge-high">Very High</span></td>
          <td data-label="Rank">Local Chief</td>
          <td data-label="Family">Veterans</td>
          <td data-label="Shooter 1" contenteditable="true" data-field="shooter1"></td>
          <td data-label="Shooter 2" contenteditable="true" data-field="shooter2"></td>
          <td data-label="Following" contenteditable="true" data-field="following"></td>
        </tr>
      </tbody>
    </table>
  </div>

<script>
(function(){
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJh2mWkJW-ak-6GrP0E9EStKDnH0O0NU_4CZTA6uMOUkEc-yM3tPcE8rN23lcsxVhIDA/exec";
  const API_KEY = "ArkhamCoreSecret123";

  const table = document.getElementById("veteransTable");
  const tbody = table.querySelector("tbody");

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  function setStatus(kind, text){
    statusDot.classList.remove("ok","bad");
    if (kind === "ok") statusDot.classList.add("ok");
    if (kind === "bad") statusDot.classList.add("bad");
    statusText.textContent = text;
  }

  // ---- JSONP LOAD (évite CORS) ----
  function loadSharedData(){
    return new Promise((resolve) => {
      setStatus("", "Chargement…");

      const cbName = "cb_" + Math.random().toString(36).slice(2);
      window[cbName] = (json) => {
        try {
          if (!json || !json.ok) {
            console.warn("Load failed:", json);
            setStatus("bad", "Erreur de chargement");
            return resolve(false);
          }

          tbody.querySelectorAll("tr[data-id]").forEach(tr => {
            const id = tr.getAttribute("data-id");
            const row = json.rows && json.rows[id];
            if (!row) return;

            tr.querySelectorAll("td[data-field]").forEach(td => {
              const field = td.getAttribute("data-field");
              td.textContent = (row[field] ?? "").toString();
            });
          });

          setStatus("ok", "Données partagées chargées");
          resolve(true);
        } finally {
          delete window[cbName];
          script.remove();
        }
      };

      const url =
        `${SCRIPT_URL}?action=list&key=${encodeURIComponent(API_KEY)}&callback=${encodeURIComponent(cbName)}&t=${Date.now()}`;

      const script = document.createElement("script");
      script.src = url;
      script.onerror = () => {
        delete window[cbName];
        script.remove();
        setStatus("bad", "Erreur réseau (load)");
        resolve(false);
      };
      document.head.appendChild(script);
    });
  }

  // ---- SAVE via GET "beacon" (pas besoin de lire la réponse) ----
  function saveCell(tr, field, value){
    const id = tr.getAttribute("data-id");
    if (!id) return;

    const url =
      `${SCRIPT_URL}?action=save&key=${encodeURIComponent(API_KEY)}&id=${encodeURIComponent(id)}&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}&t=${Date.now()}`;

    // Fire-and-forget: Image() évite CORS (on ne lit pas la réponse)
    const img = new Image();
    img.src = url;

    setStatus("ok", "Sauvegardé");
  }

  // Debounce par cellule
  const pending = new Map();
  const cellKey = (tr, field) => `${tr.getAttribute("data-id")}:${field}`;

  table.addEventListener("blur", (e) => {
    const td = e.target.closest("td[data-field][contenteditable='true']");
    if (!td) return;

    const tr = td.closest("tr[data-id]");
    if (!tr) return;

    const field = td.getAttribute("data-field");
    let value = (td.textContent || "").trim().slice(0, 40);
    td.textContent = value;

    const k = cellKey(tr, field);
    if (pending.get(k)) clearTimeout(pending.get(k));

    td.setAttribute("data-saving", "true");
    pending.set(k, setTimeout(() => {
      saveCell(tr, field, value);
      td.removeAttribute("data-saving");
    }, 250));
  }, true);

  table.addEventListener("keydown", (e) => {
    const td = e.target.closest("td[data-field][contenteditable='true']");
    if (!td) return;
    if (e.key === "Enter") { e.preventDefault(); td.blur(); }
  });

  loadSharedData();
})();
</script>

</body>
</html>
